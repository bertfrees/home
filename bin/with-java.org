* Select Java version

#+NAME: with-java
#+BEGIN_SRC clojure :tangle with-java :tangle-mode (identity #o755)
#!/usr/bin/env bb

;; This file is automatically generated from with-java.org. Don't make
;; changes to this file directly.

(require '[babashka.process :refer [exec sh]]
         '[clojure.java.io :as io])

(let [[version & args] ,*command-line-args*
      brew-home (io/file (case (.trim (:out (sh "uname -m")))
                           "x86_64" "/usr/local"
                           "/opt/homebrew"))
      java (case version
             "8"  (io/file "/Library/Java/JavaVirtualMachines/zulu-8.jdk/Contents/Home/bin/java")
             "11" (io/file brew-home "opt/openjdk@11/bin/java")
             "17" (io/file brew-home "opt/openjdk@17/bin/java")
             (do (binding [*out* *err*]
                   (println "Unsupported Java version:" version))
                 (System/exit 1)))
      java-home (.getParentFile (.getParentFile java))]
  (when-not (.exists java)
    (let [home-dir (.getParentFile (.getParentFile (io/file *file*)))]
      (when (not (= 0 (:exit (sh {:dir home-dir :out :inherit :err :inherit}
                             "bin/make" (.getPath java)))))
        (System/exit 1))))
  (if (empty? args)
    (exec {:extra-env {"JAVA_HOME" (.getPath java-home)}} "zsh")
    (apply exec {:extra-env {"JAVA_HOME" (.getPath java-home)}} args)))
#+END_SRC
